"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ImportMapExternalsPlugin = void 0;
const webpack_1 = require("webpack");
class ImportMapExternalsPlugin {
    constructor(options) {
        this.options = options;
    }
    apply(compiler) {
        const importMapPromise = this.fetchImportMap();
        compiler.hooks.normalModuleFactory.tap("ImportMapExternalsPlugin", (nmf) => {
            nmf.hooks.factorize.tapPromise("ImportMapExternalsPlugin", async (resolveData) => {
                const importMap = await importMapPromise;
                if (Object.keys(importMap?.imports || {}).includes(resolveData.request)) {
                    return new webpack_1.ExternalModule(resolveData.request, compiler.options.output.library?.type || "module", resolveData.createData.userRequest || resolveData.request);
                }
            });
        });
    }
    async fetchImportMap() {
        const r = await fetch(this.options.importMapUrl);
        if (r.ok) {
            return r.json();
        }
        else {
            throw Error(`Failed to load import map from url '${this.options.importMapUrl}'`);
        }
    }
}
exports.ImportMapExternalsPlugin = ImportMapExternalsPlugin;
